name: Server And Client Are Buildable

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4
      # Setup a nodejs envirnment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install server dependencies
      - name: Install dependencies in server/
        run: |
          cd server
          npm install
          
      # Start the server
      - name: Start Server
        run: | 
          cd server
          nohup npm start &  # Start the server in the background
          sleep 20           # Wait for 20 seconds to ensure it's running
        env:
          API_URL: ${{ secrets.API_URL }}  # Pass API_URL as a secret
          DATABASE_URL: ${{ secrets.API_URL }}  # Set DATABASE_URL to the same value

     #Verify Server is running on default 8080
      - name: Verify Server is Running
        run: |
          if ! lsof -i :8080 > /dev/null; then
            echo "Server did not start or crashed (nothing is listening on port 8080)"
            exit 1
          fi
          
  build-client:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Setup a nodejs environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install client dependencies
      - name: Install dependencies in client/
        run: |
          cd client
          npm install

      # Start the client
      - name: Start Client
        run: | 
          cd client
          nohup npm start &  # Start the client in the background
          sleep 20           # Wait for 20 seconds to ensure it's running

      #Verify Client is running on default 8081
      - name: Verify Client is Running
        run: |
          if ! lsof -i :8081 > /dev/null; then
            echo "Client did not start or crashed (nothing is listening on port 8081)"
            exit 1
          fi
        
